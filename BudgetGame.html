<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Budget Game</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f7f7fa; margin: 0; }
    .container { max-width: 600px; margin: 40px auto; background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px #ddd; }
    .center { text-align: center; margin-top: 120px; }
    .hp-bar { background: #eee; border-radius: 8px; overflow: hidden; margin-bottom: 16px; }
    .hp-fill { height: 24px; background: #76c7c0; transition: width 0.3s; }
    .warning { color: #c0392b; font-weight: bold; }
    .success { color: #27ae60; font-weight: bold; }
    label { display: block; margin-top: 12px; }
    input[type="number"], input[type="text"], input[type="password"] { width: 100%; padding: 6px; margin-top: 4px; }
    button { margin-top: 10px; padding: 8px 20px; border: none; background: #76c7c0; color: #fff; border-radius: 4px; cursor: pointer; transition: all 0.3s; }
    ul { padding-left: 20px; }
    .section { margin-bottom: 32px; }
    .form-popup { display: none; background: #f9f9f9; border: 1px solid #ccc; padding: 16px; border-radius: 8px; margin-top: 8px; }
    .form-popup label { margin-top: 0; }
    .form-actions { text-align: right; }
    #analysisSection { display: none; }
    .character-area { text-align: center; margin: 24px 0 24px 0; }
    .character-area img { width: 120px; height: 120px; object-fit: contain; }
    .tab-btn { margin: 0 8px; padding: 8px 20px; border: none; border-radius: 4px; background: #eee; color: #333; cursor: pointer; }
    .tab-btn.active { background: #76c7c0; color: #fff; }
    .logout-btn { float: right; background: #c0392b; }
    /* í•´ê¸ˆ ë³´ìƒ ìŠ¤íƒ€ì¼ */
    .reward-bg-1 { background: linear-gradient(120deg, #ffe082 0%, #ffb300 100%) !important; }
    .reward-bg-2 { background: linear-gradient(120deg, #b2dfdb 0%, #009688 100%) !important; }
    .reward-font-1 { font-family: 'Comic Sans MS', cursive, sans-serif !important; color: #ff5722 !important; }
    .reward-font-2 { font-family: 'Nanum Brush Script', cursive, sans-serif !important; color: #3949ab !important; }
    .reward-btn-1 { background: #ffb300 !important; color: #fff !important; font-weight: bold !important; border: 2px solid #ff9800 !important; }
    .reward-btn-2 { background: #009688 !important; color: #fff !important; font-weight: bold !important; border: 2px solid #00695c !important; }
    .reward-h1-1 { color: #ff6f00 !important; text-shadow: 2px 2px 8px #fff59d; }
    .reward-h1-2 { color: #3949ab !important; text-shadow: 2px 2px 8px #b3e5fc; }
    .unlock-badge { display:inline-block; margin:0 6px; padding:3px 8px; border-radius:10px; font-size:0.95em; background:#eee; color:#888; }
    .unlock-badge.unlocked { background:#ffd54f; color:#ff6f00; font-weight:bold; }
    .unlock-badge.applied { border:2px solid #3949ab; }
    .reward-apply-btn { margin-left:8px; font-size:0.92em; padding:2px 10px; }
    .reward-apply-btn[disabled] { background:#ddd; color:#aaa; cursor:not-allowed; }
  </style>
  <link href="https://fonts.googleapis.com/css?family=Nanum+Brush+Script&display=swap" rel="stylesheet">
</head>
<body>
  <!-- ì´ˆê¸°í™”ë©´ -->
  <div id="startScreen" class="container center">
    <h1>Budget Game</h1>
    <button id="startBtn">ê²Œì„ ì‹œì‘</button>
  </div>

  <!-- íšŒì›ê°€ì…/ë¡œê·¸ì¸ í™”ë©´ -->
  <div id="authScreen" class="container" style="display:none;">
    <h1>Budget Game</h1>
    <div style="text-align:center;">
      <button class="tab-btn active" id="loginTabBtn" onclick="switchAuthTab('login')">ë¡œê·¸ì¸</button>
      <button class="tab-btn" id="registerTabBtn" onclick="switchAuthTab('register')">íšŒì›ê°€ì…</button>
    </div>
    <!-- ë¡œê·¸ì¸ í¼ -->
    <form id="loginForm" style="margin-top:24px;">
      <label>ì•„ì´ë””
        <input type="text" id="loginUsername" required>
      </label>
      <label>ë¹„ë°€ë²ˆí˜¸
        <input type="password" id="loginPassword" required>
      </label>
      <button type="submit">ë¡œê·¸ì¸</button>
      <div id="loginMsg" class="warning"></div>
    </form>
    <!-- íšŒì›ê°€ì… í¼ -->
    <form id="registerForm" style="display:none; margin-top:24px;">
      <label>ì•„ì´ë””
        <input type="text" id="registerUsername" required>
      </label>
      <label>ë¹„ë°€ë²ˆí˜¸
        <input type="password" id="registerPassword" required>
      </label>
      <label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸
        <input type="password" id="registerPassword2" required>
      </label>
      <button type="submit">íšŒì›ê°€ì…</button>
      <div id="registerMsg" class="warning"></div>
    </form>
  </div>

  <!-- ë©”ì¸ ê²Œì„ í™”ë©´ -->
  <div id="mainScreen" class="container" style="display:none;">
    <button class="logout-btn" onclick="logout()" style="float:right;">ë¡œê·¸ì•„ì›ƒ</button>
    <h1 id="mainTitle">Budget Game</h1>
    <div class="section">
      <div class="hp-bar">
        <div id="hpFill" class="hp-fill" style="width: 100%"></div>
      </div>
      <div>í˜„ì¬ HP(ì”ê³ ): <span id="currentHp"></span> / <span id="maxHp"></span></div>
      <div id="warningMsg" class="warning"></div>
    </div>
    <!-- ìºë¦­í„° ì˜ì—­ -->
    <div class="character-area">
      <img id="characterImg" src="https://github.com/tngus0814/tngus0814.github.io/blob/main/smile.png?raw=true" alt="ìºë¦­í„°">
      <div id="characterStatus" style="margin-top:8px; font-weight:bold;"></div>
    </div>
    <div class="section">
      <h2>ì˜ˆì‚° ì„¤ì •</h2>
      <label>ì´ˆê¸° ì˜ˆì‚° ì…ë ¥ (ì›):
        <input type="number" id="initBudget" min="1" />
      </label>
      <button id="setBudgetBtn" onclick="handleSetBudget()">ì„¤ì •</button>
    </div>
    <div class="section">
      <h2>ìˆ˜ì…/ì§€ì¶œ/ëª©í‘œ ê´€ë¦¬</h2>
      <button id="addIncomeBtn" onclick="showForm('incomeForm')">ìˆ˜ì… ì¶”ê°€</button>
      <button id="addExpenseBtn" onclick="showForm('expenseForm')">ì§€ì¶œ ì¶”ê°€</button>
      <button id="setGoalBtn" onclick="showForm('goalForm')">ëª©í‘œ ì„¤ì •</button>
      <!-- ìˆ˜ì… ì…ë ¥ í¼ -->
      <div id="incomeForm" class="form-popup">
        <label>ìˆ˜ì… (ì›):
          <input type="number" id="incomeAmt" min="1" />
        </label>
        <label>ì„¤ëª…:
          <input type="text" id="incomeDesc" placeholder="ì„¤ëª…" />
        </label>
        <div class="form-actions">
          <button type="button" onclick="handleAddIncome(); hideForm('incomeForm');">ë“±ë¡</button>
          <button type="button" onclick="hideForm('incomeForm')">ì·¨ì†Œ</button>
        </div>
      </div>
      <!-- ì§€ì¶œ ì…ë ¥ í¼ -->
      <div id="expenseForm" class="form-popup">
        <label>ì§€ì¶œ (ì›):
          <input type="number" id="expenseAmt" min="1" />
        </label>
        <label>ì„¤ëª…:
          <input type="text" id="expenseDesc" placeholder="ì„¤ëª…" />
        </label>
        <div class="form-actions">
          <button type="button" onclick="handleAddExpense(); hideForm('expenseForm');">ë“±ë¡</button>
          <button type="button" onclick="hideForm('expenseForm')">ì·¨ì†Œ</button>
        </div>
      </div>
      <!-- ëª©í‘œ ì…ë ¥ í¼ -->
      <div id="goalForm" class="form-popup">
        <label>ëª©í‘œ HP(ì”ê³ ) ì…ë ¥:
          <input type="number" id="goalHp" min="1" />
        </label>
        <div class="form-actions">
          <button type="button" onclick="handleSetGoal(); hideForm('goalForm');">ë“±ë¡</button>
          <button type="button" onclick="hideForm('goalForm')">ì·¨ì†Œ</button>
        </div>
      </div>
      <div id="goalStatus" style="margin-top:8px;"></div>
    </div>
    <div class="section">
      <button onclick="toggleAnalysis()" id="analysisBtn">ì˜ˆì‚° ë¶„ì„í•˜ê¸°</button>
      <div id="analysisSection">
        <h2>ìˆ˜ì… ë‚´ì—­</h2>
        <ul id="incomeList"></ul>
        <h2>ì§€ì¶œ ë‚´ì—­</h2>
        <ul id="expenseList"></ul>
      </div>
    </div>
    <!-- í•´ê¸ˆ í˜„í™© í‘œì‹œ -->
    <div class="section" id="unlockSection">
      <h2>í•´ê¸ˆëœ ê¾¸ë¯¸ê¸° ë³´ìƒ</h2>
      <div id="unlockBadges"></div>
    </div>
  </div>
  <script>
    // --- ë³´ìƒ ë‹¨ê³„ ì •ì˜ ---
    const rewardStages = [
      {
        name: "ë°°ê²½ìƒ‰ í•´ê¸ˆ",
        classNames: ['reward-bg-1'],
        targets: [() => document.getElementById('mainScreen')],
      },
      {
        name: "í°íŠ¸/ìƒ‰ìƒ í•´ê¸ˆ",
        classNames: ['reward-font-1', 'reward-h1-1'],
        targets: [
          () => document.getElementById('mainScreen'),
          () => document.getElementById('mainTitle')
        ],
      },
      {
        name: "ë²„íŠ¼ ìŠ¤íƒ€ì¼ í•´ê¸ˆ",
        classNames: ['reward-btn-1'],
        targets: [
          () => document.getElementById('setBudgetBtn'),
          () => document.getElementById('addIncomeBtn'),
          () => document.getElementById('addExpenseBtn'),
          () => document.getElementById('setGoalBtn')
        ],
      },
      {
        name: "ë‘ ë²ˆì§¸ ë°°ê²½ í•´ê¸ˆ",
        classNames: ['reward-bg-2'],
        targets: [() => document.getElementById('mainScreen')],
      },
      {
        name: "ë‘ ë²ˆì§¸ í°íŠ¸/ìƒ‰ìƒ í•´ê¸ˆ",
        classNames: ['reward-font-2', 'reward-h1-2'],
        targets: [
          () => document.getElementById('mainScreen'),
          () => document.getElementById('mainTitle')
        ],
      },
      {
        name: "ë‘ ë²ˆì§¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ í•´ê¸ˆ",
        classNames: ['reward-btn-2'],
        targets: [
          () => document.getElementById('setBudgetBtn'),
          () => document.getElementById('addIncomeBtn'),
          () => document.getElementById('addExpenseBtn'),
          () => document.getElementById('setGoalBtn')
        ],
      }
    ];

    // --- ê°ì²´ì§€í–¥ í´ë˜ìŠ¤ ì •ì˜ ---
    class BudgetData {
      constructor() {
        this.maxHp = 0;
        this.currentHp = 0;
        this.incomes = [];
        this.expenses = [];
        this.goalHp = null;
        this.goalUnlockCount = 0; // ëª©í‘œ ë‹¬ì„± íšŸìˆ˜(í•´ê¸ˆ ë‹¨ê³„)
        this.appliedRewards = []; // ì—¬ëŸ¬ ë³´ìƒ ì ìš© ìƒíƒœ
      }
      setBudget(hp) {
        this.maxHp = hp;
        this.currentHp = hp;
        this.incomes = [];
        this.expenses = [];
        this.goalHp = null;
      }
      addIncome(amount, desc) {
        this.incomes.push({ amount, desc });
        this.currentHp += amount;
        if (this.currentHp > this.maxHp) this.maxHp = this.currentHp;
      }
      addExpense(amount, desc) {
        if (amount > this.currentHp) return false;
        this.expenses.push({ amount, desc });
        this.currentHp -= amount;
        return true;
      }
      setGoal(hp) {
        this.goalHp = hp;
      }
    }

    class User {
      constructor(username, password) {
        this.username = username;
        this.password = password;
        this.data = new BudgetData();
      }
      checkPassword(pw) {
        return this.password === pw;
      }
    }

    class BudgetGame {
      constructor() {
        this.users = this.loadUsers();
        this.currentUser = null;
        this.warningThreshold = 0.2;
      }
      register(username, password) {
        if (this.users[username]) return false;
        this.users[username] = new User(username, password);
        this.saveUsers();
        return true;
      }
      login(username, password) {
        const user = this.users[username];
        if (!user || !user.checkPassword(password)) return false;
        this.currentUser = user;
        return true;
      }
      logout() {
        this.currentUser = null;
      }
      saveUsers() {
        const usersObj = {};
        for (const [k, v] of Object.entries(this.users)) {
          usersObj[k] = {
            username: v.username,
            password: v.password,
            data: v.data
          };
        }
        localStorage.setItem('bg_users_oop', JSON.stringify(usersObj));
      }
      loadUsers() {
        const raw = localStorage.getItem('bg_users_oop');
        if (!raw) return {};
        const obj = JSON.parse(raw);
        const users = {};
        for (const [k, v] of Object.entries(obj)) {
          const user = new User(v.username, v.password);
          Object.assign(user.data, v.data);
          users[k] = user;
        }
        return users;
      }
      saveCurrentUserData() {
        this.saveUsers();
      }
    }

    // --- ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° UI ì—°ê²° ---
    const game = new BudgetGame();

    // ì—¬ëŸ¬ ë³´ìƒ ëˆ„ì  ì ìš©/í•´ì œ
    function applyAllRewards(appliedArr) {
      // ëª¨ë“  ë³´ìƒ í´ë˜ìŠ¤ ì œê±°
      rewardStages.forEach((stage, idx) => {
        stage.targets.forEach((getTarget, c) => {
          const el = getTarget();
          if (!el) return;
          stage.classNames.forEach(cls => el.classList.remove(cls));
        });
      });
      // ì ìš©ëœ ë³´ìƒë§Œ ëª¨ë‘ add
      if (!Array.isArray(appliedArr)) return;
      appliedArr.forEach(idx => {
        const stage = rewardStages[idx];
        if (!stage) return;
        stage.targets.forEach((getTarget, c) => {
          const el = getTarget();
          if (!el) return;
          stage.classNames.forEach(cls => el.classList.add(cls));
        });
      });
      renderUnlockBadges();
    }

    // í•´ê¸ˆ í˜„í™© UI + ì ìš©/í•´ì œ ë²„íŠ¼
    function renderUnlockBadges() {
      if (!game.currentUser) return;
      const unlockCount = game.currentUser.data.goalUnlockCount || 0;
      const appliedArr = game.currentUser.data.appliedRewards || [];
      const el = document.getElementById('unlockBadges');
      el.innerHTML = rewardStages.map((r, i) => {
        const applied = appliedArr.includes(i);
        return `<span class="unlock-badge${i < unlockCount ? ' unlocked' : ''}${applied ? ' applied' : ''}">
          ${r.name}
          <button class="reward-apply-btn" ${i < unlockCount ? '' : 'disabled'} onclick="toggleReward(${i})">
            ${applied ? 'í•´ì œ' : 'ì ìš©'}
          </button>
        </span>`;
      }).join('');
    }

    // ë³´ìƒ ì ìš©/í•´ì œ ë²„íŠ¼ í•¸ë“¤ëŸ¬
    window.toggleReward = function(idx) {
      if (!game.currentUser) return;
      const unlockCount = game.currentUser.data.goalUnlockCount || 0;
      if (idx >= unlockCount) return;
      let arr = game.currentUser.data.appliedRewards || [];
      if (arr.includes(idx)) {
        arr = arr.filter(x => x !== idx);
      } else {
        arr.push(idx);
      }
      game.currentUser.data.appliedRewards = arr;
      game.saveCurrentUserData();
      applyAllRewards(arr);
    };

    // í™”ë©´ ì „í™˜
    document.getElementById('startBtn').onclick = function() {
      showScreen('auth');
    };

    function showScreen(screen) {
      document.getElementById('startScreen').style.display = (screen === 'start') ? 'block' : 'none';
      document.getElementById('authScreen').style.display = (screen === 'auth') ? 'block' : 'none';
      document.getElementById('mainScreen').style.display = (screen === 'main') ? 'block' : 'none';
    }

    function switchAuthTab(tab) {
      document.getElementById('loginTabBtn').classList.remove('active');
      document.getElementById('registerTabBtn').classList.remove('active');
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'none';
      if (tab === 'login') {
        document.getElementById('loginTabBtn').classList.add('active');
        document.getElementById('loginForm').style.display = 'block';
      } else {
        document.getElementById('registerTabBtn').classList.add('active');
        document.getElementById('registerForm').style.display = 'block';
      }
    }

    // íšŒì›ê°€ì…
    document.getElementById('registerForm').onsubmit = function(e) {
      e.preventDefault();
      const username = document.getElementById('registerUsername').value.trim();
      const password = document.getElementById('registerPassword').value;
      const password2 = document.getElementById('registerPassword2').value;
      const msg = document.getElementById('registerMsg');
      msg.innerText = '';
      if (!username || !password) {
        msg.innerText = 'ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
        return;
      }
      if (password !== password2) {
        msg.innerText = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        return;
      }
      if (!game.register(username, password)) {
        msg.innerText = 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.';
        return;
      }
      alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      switchAuthTab('login');
      document.getElementById('loginUsername').value = username;
      document.getElementById('loginPassword').value = '';
    };

    // ë¡œê·¸ì¸
    document.getElementById('loginForm').onsubmit = function(e) {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const msg = document.getElementById('loginMsg');
      msg.innerText = '';
      if (!game.login(username, password)) {
        msg.innerText = 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        return;
      }
      showScreen('main');
      updateHpBar();
      renderLists();
      document.getElementById('goalStatus').innerText = '';
      hideAllForms();
      // ë¡œê·¸ì¸ ì‹œ í•´ê¸ˆ í˜„í™© ë° ì ìš©ëœ ë³´ìƒ ì ìš©
      if (game.currentUser) {
        applyAllRewards(game.currentUser.data.appliedRewards);
      }
    };

    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
      game.logout();
      showScreen('start');
      switchAuthTab('login');
      document.getElementById('loginMsg').innerText = '';
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginPassword').value = '';
      hideAllForms();
    }

    // í¼ í‘œì‹œ/ìˆ¨ê¹€
    function showForm(formId) {
      hideAllForms();
      document.getElementById(formId).style.display = 'block';
    }
    function hideForm(formId) {
      document.getElementById(formId).style.display = 'none';
      if(formId==='incomeForm'){
        document.getElementById('incomeAmt').value = '';
        document.getElementById('incomeDesc').value = '';
      }else if(formId==='expenseForm'){
        document.getElementById('expenseAmt').value = '';
        document.getElementById('expenseDesc').value = '';
      }else if(formId==='goalForm'){
        document.getElementById('goalHp').value = '';
      }
    }
    function hideAllForms() {
      document.getElementById('incomeForm').style.display = 'none';
      document.getElementById('expenseForm').style.display = 'none';
      document.getElementById('goalForm').style.display = 'none';
    }

    // ì˜ˆì‚° ë¶„ì„ ë‚´ì—­ í‘œì‹œ/ìˆ¨ê¹€
    function toggleAnalysis() {
      const section = document.getElementById('analysisSection');
      const btn = document.getElementById('analysisBtn');
      if (section.style.display === 'none' || section.style.display === '') {
        section.style.display = 'block';
        btn.innerText = 'ë¶„ì„ ë‹«ê¸°';
        renderLists();
      } else {
        section.style.display = 'none';
        btn.innerText = 'ì˜ˆì‚° ë¶„ì„í•˜ê¸°';
      }
    }

    // ìºë¦­í„° ìƒíƒœë³„ ì´ë¯¸ì§€
    const characterStates = [
      {
        min: 0.7,
        img: "https://github.com/tngus0814/tngus0814.github.io/blob/main/smile.png?raw=true",
        status: "í–‰ë³µí•œ ìƒíƒœ!"
      },
      {
        min: 0.3,
        img: "https://github.com/tngus0814/tngus0814.github.io/blob/main/ddd.png?raw=true",
        status: "í‰ë²”í•œ ìƒíƒœ"
      },
      {
        min: 0,
        img: "https://github.com/tngus0814/tngus0814.github.io/blob/main/sad.png?raw=true",
        status: "ìŠ¬í”ˆ ìƒíƒœ..."
      }
    ];

    function updateCharacter() {
      if (!game.currentUser) return;
      let percent = game.currentUser.data.maxHp ? (game.currentUser.data.currentHp / game.currentUser.data.maxHp) : 1;
      let state = characterStates.find(s => percent >= s.min);
      document.getElementById('characterImg').src = state.img;
      document.getElementById('characterStatus').innerText = state.status;
    }

    // ëª©í‘œ ë‹¬ì„± ì‹œ í•´ê¸ˆ ë³´ìƒ ì²˜ë¦¬
    function updateHpBar() {
      if (!game.currentUser) return;
      const d = game.currentUser.data;
      document.getElementById('currentHp').innerText = d.currentHp;
      document.getElementById('maxHp').innerText = d.maxHp;
      let percent = d.maxHp ? (d.currentHp / d.maxHp * 100) : 0;
      document.getElementById('hpFill').style.width = percent + "%";
      if (percent <= game.warningThreshold * 100) {
        document.getElementById('warningMsg').innerText = "ê²½ê³ : HPê°€ ë„ˆë¬´ ë‚®ìŠµë‹ˆë‹¤!";
      } else {
        document.getElementById('warningMsg').innerText = "";
      }
      // ëª©í‘œ ë‹¬ì„± ì‹œ í•´ê¸ˆ
      if (d.goalHp !== null) {
        if (d.currentHp >= d.goalHp) {
          document.getElementById('goalStatus').innerHTML = '<span class="success">ì¶•í•˜í•©ë‹ˆë‹¤! ëª©í‘œ ë‹¬ì„± ğŸ‰</span>';
          // ëª©í‘œ ë‹¬ì„± ì‹œ í•´ê¸ˆ ë‹¨ê³„ ì¦ê°€(ì¤‘ë³µ ë°©ì§€)
          if (!d._goalJustUnlocked) {
            d.goalUnlockCount = (d.goalUnlockCount || 0) + 1;
            d._goalJustUnlocked = true; // í”Œë˜ê·¸ë¡œ ì¤‘ë³µ ë°©ì§€
            game.saveCurrentUserData();
          }
        } else {
          document.getElementById('goalStatus').innerText = 'ëª©í‘œê¹Œì§€ ' + (d.goalHp - d.currentHp) + ' ë‚¨ìŒ';
          d._goalJustUnlocked = false;
        }
      }
      // ì ìš©ëœ ë³´ìƒ ëª¨ë‘ ì ìš©
      applyAllRewards(d.appliedRewards);
      updateCharacter();
    }

    function handleSetBudget() {
      if (!game.currentUser) return;
      const val = parseInt(document.getElementById('initBudget').value, 10);
      if (isNaN(val) || val <= 0) {
        alert('ì˜¬ë°”ë¥¸ ì˜ˆì‚°ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }
      game.currentUser.data.setBudget(val);
      game.saveCurrentUserData();
      renderLists();
      updateHpBar();
      document.getElementById('goalStatus').innerText = '';
    }

    function handleAddIncome() {
      if (!game.currentUser) return;
      const amt = parseInt(document.getElementById('incomeAmt').value, 10);
      const desc = document.getElementById('incomeDesc').value || 'ìˆ˜ì…';
      if (isNaN(amt) || amt <= 0) {
        alert('ìˆ˜ì… ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }
      game.currentUser.data.addIncome(amt, desc);
      game.saveCurrentUserData();
      renderLists();
      updateHpBar();
      document.getElementById('incomeAmt').value = '';
      document.getElementById('incomeDesc').value = '';
    }

    function handleAddExpense() {
      if (!game.currentUser) return;
      const amt = parseInt(document.getElementById('expenseAmt').value, 10);
      const desc = document.getElementById('expenseDesc').value || 'ì§€ì¶œ';
      if (isNaN(amt) || amt <= 0) {
        alert('ì§€ì¶œ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }
      if (!game.currentUser.data.addExpense(amt, desc)) {
        alert('ì”ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
        return;
      }
      game.saveCurrentUserData();
      renderLists();
      updateHpBar();
      document.getElementById('expenseAmt').value = '';
      document.getElementById('expenseDesc').value = '';
    }

    function handleSetGoal() {
      if (!game.currentUser) return;
      const val = parseInt(document.getElementById('goalHp').value, 10);
      if (isNaN(val) || val <= 0) {
        alert('ì˜¬ë°”ë¥¸ ëª©í‘œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }
      game.currentUser.data.setGoal(val);
      game.saveCurrentUserData();
      updateHpBar();
      document.getElementById('goalHp').value = '';
    }

    function renderLists() {
      if (!game.currentUser) return;
      const d = game.currentUser.data;
      if (document.getElementById('analysisSection').style.display === 'block') {
        const incomeList = document.getElementById('incomeList');
        incomeList.innerHTML = d.incomes.length
          ? d.incomes.map(i => `<li>${i.desc}: +${i.amount}ì›</li>`).join('')
          : '<li>ìˆ˜ì… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
        const expenseList = document.getElementById('expenseList');
        expenseList.innerHTML = d.expenses.length
          ? d.expenses.map(e => `<li>${e.desc}: -${e.amount}ì›</li>`).join('')
          : '<li>ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
      }
    }

    // í•­ìƒ ê²Œì„ ì‹œì‘ í™”ë©´ë¶€í„° ë³´ì´ê²Œ(ìƒˆë¡œê³ ì¹¨/ì¬ì ‘ì† ì‹œ)
    window.onload = function() {
      showScreen('start');
      switchAuthTab('login');
      hideAllForms();
    };
  </script>
</body>
</html>
